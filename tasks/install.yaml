---

- name: "uninstall installed awscli version {{ awscli_installed_version.full_version }}"
  package:
    name: awscli
    state: absent
  when:
    - awscli_installed_version is defined
    - awscli_installed_version.version is defined
    - awscli_installed_version.version.major is defined
    - awscli_installed_version.version.major | int == 1

- block:
    - name: remove old awscli version {{ awscli_installed_version.full_version }}
      file:
        state: absent
        path: /usr/local/aws-cli

    - name: remove old version link to aws
      file:
        state: absent
        path: "/usr/local/bin/aws_{{ awscli_installed_version.full_version }}"
  when:
    - awscli_reinstall is defined
    - awscli_reinstall
    - awscli_installed_version is defined
    - awscli_installed_version.full_version is defined

- name: extract awscli archive
  unarchive:
    src: "/tmp/{{ awscli_archiv }}"
    dest: "/var/tmp"
    copy: false

- name: install awscli {{ awscli_version }}
  become: true
  command: /var/tmp/aws/install
  args:
    chdir: /var/tmp/aws/
    warn: false
    #creates: /usr/local/bin/aws

- name: create version link to aws
  file:
    src: "/usr/local/bin/aws"
    dest: "/usr/local/bin/aws_{{ awscli_version }}"
    state: link
    force: true

- name: remove awscli archive
  file:
    path: "/tmp/{{ awscli_archiv }}"
    state: absent

- name: remove awscli install files
  file:
    path: "/var/tmp/aws"
    state: absent

...
